#!/bin/bash
set -euo pipefail

mkdir -p "$HOME/.claude"

python3 - <<'PY'
import json, os, sys

base_path = os.path.expanduser("~/.claude/settings.json")
tpl_path  = os.path.expanduser("~/.claude/settings.glm.json")

# Load base (keep enabledPlugins etc.)
try:
    with open(base_path, "r", encoding="utf-8") as f:
        base = json.load(f)
except FileNotFoundError:
    base = {}
except json.JSONDecodeError:
    print("ERROR: ~/.claude/settings.json is not valid JSON", file=sys.stderr)
    raise

# Load GLM template
with open(tpl_path, "r", encoding="utf-8") as f:
    tpl = json.load(f)

env_tpl = tpl.get("env")
if not isinstance(env_tpl, dict):
    raise SystemExit('Template ~/.claude/settings.glm.json must contain {"env": {...}}')

env = dict(env_tpl)

# Always on
env["ENABLE_TOOL_SEARCH"] = "1"

# Pin models to 4.7
env["ANTHROPIC_DEFAULT_HAIKU_MODEL"] = "glm-4.7-flash"
env["ANTHROPIC_DEFAULT_SONNET_MODEL"] = "glm-4.7"
env["ANTHROPIC_DEFAULT_OPUS_MODEL"] = "glm-4.7"

base["env"] = env

with open(base_path, "w", encoding="utf-8") as f:
    json.dump(base, f, ensure_ascii=False, indent=2)
PY

chmod 600 "$HOME/.claude/settings.json" 2>/dev/null || true
echo "OK: включён GLM (Z.ai) pinned glm-4.7. ENABLE_TOOL_SEARCH=1. Перезапусти TRAE или Developer: Reload Window."
