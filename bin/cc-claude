#!/bin/bash
set -euo pipefail

mkdir -p "$HOME/.claude"

python3 - <<'PY'
import json, os, sys

base_path = os.path.expanduser("~/.claude/settings.json")
tpl_path  = os.path.expanduser("~/.claude/settings.claude.json")

try:
    with open(base_path, "r", encoding="utf-8") as f:
        base = json.load(f)
except FileNotFoundError:
    base = {}
except json.JSONDecodeError:
    print("ERROR: ~/.claude/settings.json is not valid JSON", file=sys.stderr)
    raise

with open(tpl_path, "r", encoding="utf-8") as f:
    tpl = json.load(f)

env_tpl = tpl.get("env")
if not isinstance(env_tpl, dict):
    raise SystemExit('Template ~/.claude/settings.claude.json must contain {"env": {...}}')

env = dict(env_tpl)
env["ENABLE_TOOL_SEARCH"] = "1"

base["env"] = env

with open(base_path, "w", encoding="utf-8") as f:
    json.dump(base, f, ensure_ascii=False, indent=2)
PY

chmod 600 "$HOME/.claude/settings.json" 2>/dev/null || true
echo "OK: включён Claude (Anthropic). ENABLE_TOOL_SEARCH=1. Перезапусти TRAE или Developer: Reload Window."
